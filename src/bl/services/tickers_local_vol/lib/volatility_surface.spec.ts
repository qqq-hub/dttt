import { expect, test } from "@playwright/test";
import { LocalVolatilitySurface } from "./volatility_surface"; // Adjust the path as needed

function p(v: number): number {
    return v / 100;
}

function getLocalVolatilitySurfaceTestData() {
    return new LocalVolatilitySurface({
        spot: 484.45,
        days: [7, 14, 21, 28, 35],
        strikes: [0.8, 0.9, 0.95, 0.975, 1, 1.025, 1.05, 1.1, 1.2],
        riskFreeRates: [
            p(5.446),
            p(5.446),
            p(5.446),
            p(5.448),
            p(5.453),
            p(5.457)
        ],
        div: [p(0.43), p(0.43), p(0.22), p(0.14), p(0.11), p(0.09)],
        items: [
            [p(57.96), p(49.15), p(46.11), p(44.69), p(43.93)],
            [p(38.01), p(38.61), p(39.73), p(40.15), p(40.4)],
            [p(33.53), p(36.76), p(38.55), p(39.17), p(39.64)],
            [p(32.6), p(36.34), p(38.25), p(38.89), p(39.42)],
            [p(32.22), p(36.14), p(38.1), p(38.72), p(39.29)],
            [p(32.32), p(36.15), p(38.08), p(38.65), p(39.23)],
            [p(32.97), p(36.36), p(38.18), p(38.68), p(39.25)],
            [p(36.38), p(37.48), p(38.75), p(39.03), p(39.47)],
            [p(47.16), p(42.68), p(41.6), p(40.93), p(40.71)]
        ]
    });
}
test.describe
    .parallel("services::tickers_local_vl::local_volatility_surface", () => {
    test("TestLocalVolStep1", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep1();
        // prettier-ignore
        const expected = [
            [ 1.5042702623906212, 1.4589999999993644, 1.1998999999989635, 0.8854999999993294, 0.7128999999997415, 0.6486999999995483 ],
            [ 1.037812480910455, 0.9353476190469656, 0.7414333333325054, 0.610880952380489, 0.54384285714275, 0.5153047619043609 ],
            [ 0.6453046647230328, p(57.96), p(49.15), p(46.11), p(44.69), p(43.93) ],
            [ 0.3821437317784263, p(38.01), p(38.61), p(39.73), p(40.15), p(40.4) ],
            [ 0.31637988338192463, p(33.53), p(36.76), p(38.55), p(39.17), p(39.64) ],
            [ 0.3029816326530616, p(32.6), p(36.34), p(38.25), p(38.89), p(39.42) ],
            [ 0.29786355685131227, p(32.22), p(36.14), p(38.1), p(38.72), p(39.29) ],
            [ 0.2996311953352773, p(32.32), p(36.15), p(38.08), p(38.65), p(39.23) ],
            [ 0.30974577259475294, p(32.97), p(36.36), p(38.18), p(38.68), p(39.25) ],
            [ 0.36248075801749313, p(36.38), p(37.48), p(38.75), p(39.03), p(39.47) ],
            [ 0.5086177842565605, p(47.16), p(42.68), p(41.6), p(40.93), p(40.71) ]
        ];
        expect(exp.step1).toEqual(expected);
        expect(exp.strikes).toEqual([
            0.6, 0.7, 0.8, 0.9, 0.95, 0.975, 1, 1.025, 1.05, 1.1, 1.2
        ]);
        expect(exp.days).toEqual([4, 7, 14, 21, 28, 35]);
    });

    test("TestLocalVolStep2", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep2();
        const expected = [
            [
                3.3043704901001534, 2.617361253659427, 2.2857127748534114,
                2.50991458543204, 2.6896197246988356, 2.65242299775627
            ],
            [
                3.32022285571827, 2.8073421736742046, 2.5264326033523337,
                2.512207702249228, 2.4548776460731645, 2.332672775233302
            ],
            [
                3.3227097352870634, 2.8134262364540414, 2.371657145281425,
                2.0871776180080857, 1.8860442015303132, 1.7356539446605541
            ],
            [
                2.649583173980852, 2.032746650888152, 1.4485365352114825,
                1.1782428598360306, 1.0340453367164946, 0.9408062239841496
            ],
            [
                1.5714456127021044, 1.141295228022983, 0.7718559873415743,
                0.630715553643581, 0.5622088086784693, 0.5190123147501816
            ],
            [
                0.8261600361055477, 0.6011276947062376, 0.4174787507708019,
                0.35376177822676586, 0.3259770593294643, 0.30988946817625374
            ],
            [
                0.033449627552304254, 0.04417281898688087, 0.06415087634924466,
                0.07965851476878995, 0.09247622864493879, 0.10384647161832283
            ],
            [
                -0.748372017696655, -0.5037203632446454, -0.28222170108976546,
                -0.18882782091358322, -0.13663305668212902, -0.09804922181810874
            ],
            [
                -1.460940679701563, -1.0170428615997216, -0.6162538316465132,
                -0.44941562063851304, -0.359830858672001, -0.294839077770078
            ],
            [
                -2.46076357688508, -1.834201623425685, -1.2250639999066062,
                -0.9384993738111318, -0.7830117139448034, -0.6705100224376194
            ],
            [
                -3.3634934022254552, -2.724755322978615, -2.099981680069155,
                -1.733568334139664, -1.5037538586242223, -1.3317550933234945
            ]
        ];
        expect(exp.step2).toEqual(expected);
    });

    test("TestLocalVolStep3", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep3();
        const expected = [
            [
                0, -5.432431486950824, -13.325142857163474, -16.169142857124037,
                -8.876571428550232, -3.3017142857242225
            ],
            [
                0, -12.295783423618722, -9.972734693886526, -6.714122448960842,
                -3.447673469369432, -1.4676734694028695
            ],
            [
                0, -7.884559766763939, -4.530857142857143, -1.5634285714285705,
                -0.7302857142857166, -0.3908571428571398
            ],
            [
                0, -0.24524781341115798, 0.30857142857142883,
                0.5759999999999994, 0.21599999999999905, 0.12857142857142867
            ],
            [
                0, 2.2704139941690427, 1.6611428571428568, 0.920571428571427,
                0.31885714285714484, 0.24171428571428763
            ],
            [
                0, 2.7622040816326088, 1.9234285714285737, 0.9822857142857118,
                0.329142857142858, 0.2725714285714271
            ],
            [
                0, 2.9203731778425257, 2.0160000000000005, 1.0080000000000002,
                0.318857142857142, 0.29314285714285626
            ],
            [
                0, 2.8282565597667197, 1.9697142857142858, 0.9925714285714278,
                0.2931428571428591, 0.2982857142857128
            ],
            [
                0, 2.394507288629646, 1.7434285714285707, 0.9359999999999997,
                0.25714285714285734, 0.2931428571428591
            ],
            [
                0, 0.15830903790082562, 0.5657142857142834, 0.6531428571428595,
                0.14400000000000127, 0.2262857142857122
            ],
            [
                0, -4.44213411078726, -2.3039999999999976, -0.5554285714285702,
                -0.3445714285714306, -0.1131428571428561
            ]
        ];
        expect(exp.step3).toEqual(expected);
    });

    test("TestLocalVolStep4", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep4();
        const expected = [
            [0, 0, 0, 0, 0, 0],
            [
                -0.009628605252970716, -0.010809214180047452,
                -0.009463652939755561, -0.00566867680088431,
                -0.003489671645308938, -0.0027535398512785096
            ],
            [
                -0.008102132649136583, -0.007343329942139854,
                -0.005159115147744971, -0.003091773193941353,
                -0.002001091075296728, -0.001568887643809698
            ],
            [
                -0.0054321587974942, -0.004118072040458253,
                -0.0021756631231293223, -0.001316957374342038,
                -0.0009371452162245846, -0.0007286613685622883
            ],
            [
                -0.0027149901288678613, -0.0018495200743110772,
                -0.000763752709257923, -0.0004871503767158653,
                -0.00040458251625554706, -0.0003137578697491981
            ],
            [
                -0.0011062648965930834, -0.0007678811022809325,
                -0.0003467850139333192, -0.00024770358138094225,
                -0.00023119000928888099, -0.0001816492930126971
            ],
            [
                -0.00042258856862415856, -0.00031375786974920263,
                -0.0001651357209206366, -0.000123851790690474,
                -0.00014036536278253995, -0.00010733821859841264
            ],
            [
                0.0001459501276883107, 0.000082567860460316,
                0.000008256786046030684, -0.00001651357209206595,
                -0.00005779750232221937, -0.00004954071627618869
            ],
            [
                0.0008351390037754639, 0.0005366910929920515,
                0.00017339250696666187, 0.00008256786046031561,
                0.000024770358138091935, 0.000016513572092065872
            ],
            [
                0.0021771074588808033, 0.0014077820208483875,
                0.0004623800185777687, 0.00023531840231190199,
                0.0001444937558055553, 0.00009082464650634669
            ],
            [
                0.0030165553976482097, 0.0022252038394055132,
                0.001073382185984108, 0.0005882960057797515,
                0.00039219733718649986, 0.00025596036742697986
            ]
        ];
        expect(exp.step4).toEqual(expected);
    });

    test("TestLocalVolStep5", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep5();
        const expected = [
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [
                0.000007877348559366933, 0.00001788566538294761,
                0.000022213529734805347, 0.000013298088589859387,
                0.000007681807049294076, 0.000006113387385018106
            ],
            [
                0.000013778376775943794, 0.00001664391527341112,
                0.000015396078153656994, 0.00000915892155846484,
                0.000005490483326824979, 0.000004335980365607444
            ],
            [
                0.00003738180739267004, 2.9296104432772267e-5,
                1.6456570621899866e-5, 9.847430061436054e-6,
                6.74170211898315e-6, 5.245650244264998e-6
            ],
            [
                0.000039666658512105375, 2.689105901392152e-5,
                1.0832173067579713e-5, 6.665952656972154e-6,
                5.302462340773257e-6, 4.090470948596437e-6
            ],
            [
                0.000014112422911939883, 0.000009373995923866898,
                0.00000374959836954657, 0.0000025565443428727215,
                0.000001874799184773285, 0.0000015339266057237086
            ],
            [
                0.000011735755935854473, 0.000008180941897193089,
                0.000003579162080022035, 0.000002215671763823061,
                0.0000017043628952486466, 0.0000011930540266740431
            ],
            [
                0.000014226212737891521, 0.000009373995923866993,
                0.0000034087257904970883, 0.00000204523547429831,
                0.0000017043628952484495, 0.0000013634903161988731
            ],
            [
                0.00003228472989058504, 0.000020906851515048833,
                0.000006893201043005226, 0.0000035602247145192124,
                0.0000024239827843535564, 0.0000015149892402208887
            ],
            [
                0.000017687885856426515, 0.00001395683837553534,
                0.000007726445125126774, 0.000004317719334629659,
                0.0000029352916529280414, 0.000001931611281281699
            ]
        ];
        expect(exp.step5).toEqual(expected);
    });

    test("TestLocalVolStep6", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep6();
        const expected = [
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [
                0, 0.15500049857810672, 0.0643731481513021, 0.12508704749622396,
                0.14607114412512298, 0.15681016271119275
            ],
            [
                0, 0.13951956796922738, 0.15685090770492002,
                0.18313311905883997, 0.1733291516637999, 0.17197655244299997
            ],
            [
                0, 0.1414742925192831, 0.18209847872946663, 0.1894777233933999,
                0.17225102672654677, 0.17516641123026683
            ],
            [
                0, 0.14106396230700896, 0.1861822510418401, 0.1898636126849999,
                0.17080192529336008, 0.1759332754880999
            ],
            [
                0, 0.14030958318876682, 0.18715996235733334,
                0.18982503564000003, 0.1689101259178666, 0.17655249757633323
            ],
            [
                0, 0.14003213112311236, 0.1860700744457, 0.18908594302677326,
                0.16691445611943345, 0.17655197815554988
            ],
            [
                0, 0.1395792400861131, 0.18163947190895996, 0.18756310312559996,
                0.16512674677904, 0.17646315694250017
            ],
            [
                0, 0.13512254241894137, 0.15734161489322657,
                0.17998466715500014, 0.1613265913318001, 0.1733542507333665
            ],
            [
                0, 0.14212784754800165, 0.10675819503360008, 0.1469802430720001,
                0.14636362695119987, 0.1574063760492001
            ]
        ];
        expect(exp.step6).toEqual(expected);
    });

    test("TestLocalVolStep7", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep7();
        const expected = [
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [
                0, 0.008041377572906946, 0.03224135739872215,
                0.19104302750891183, 0.3796563519066505, 0.48083151325814055
            ],
            [
                0, 0.2577710467854686, 0.5715673612790392, 0.7380741186630926,
                0.8093094672457574, 0.8535049587224952
            ],
            [
                0, 0.7871249452300788, 0.9454179862956035, 0.9795923659041773,
                0.985800637253089, 0.9964990819534895
            ],
            [
                0, 0.978079201253752, 1.007333351970796, 1.013263655097625,
                1.0159939965491547, 1.0184360117743005
            ],
            [
                0, 1.0119104649845694, 1.010343681711955, 1.0110260701123464,
                1.0097428358836436, 1.010383488583299
            ],
            [
                0, 1.0069263001512445, 1.0119505259117247, 1.0128838498318804,
                1.0148225564417248, 1.0127253405106327
            ],
            [
                0, 0.9396825900967886, 0.9911623935141111, 1.0026935020610135,
                1.0107404468949888, 1.0119191323339516
            ],
            [
                0, 0.696079915578303, 0.9132355115287792, 0.9668932080084723,
                0.987588998520233, 0.9963925612838838
            ],
            [
                0, 0.30765362570188365, 0.5959690927475175, 0.7707144731656846,
                0.8501807048981601, 0.9064413514108355
            ]
        ];
        expect(exp.step7).toEqual(expected);
    });

    test("TestLocalVolStep8", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        exp.fillStep8();
        const expected = [
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [
                0, 4.390372004485462, 1.4130115618445476, 0.8091714942866454,
                0.6202787175877049, 0.5710717030365785
            ],
            [
                0, 0.7356995557542183, 0.5238534491134649, 0.49811940172188496,
                0.4627841702949896, 0.44888138423759666
            ],
            [
                0, 0.423952233269856, 0.43887539024876937, 0.4398011726644918,
                0.41800970247025454, 0.4192634123524543
            ],
            [
                0, 0.37977032595641685, 0.429914934251023, 0.43287214238357835,
                0.41001600524771126, 0.41563022319363535
            ],
            [
                0, 0.3723682327147875, 0.4303996501420203, 0.4333068631308418,
                0.4089991943865628, 0.4180168733950998
            ],
            [
                0, 0.37291942587176663, 0.42880380011368613, 0.43206570789988,
                0.40555701695782087, 0.41753266302342457
            ],
            [
                0, 0.38540720071858764, 0.4280876583340149, 0.432503478167467,
                0.404193094779451, 0.4175938736403768
            ],
            [
                0, 0.4405897126788497, 0.4150786601743814, 0.4314480394704425,
                0.4041707285193984, 0.4171113516821456
            ],
            [
                0, 0.6796863851942871, 0.4232419849165942, 0.4366995288013861,
                0.4149167422313336, 0.4167170839203356
            ]
        ];
        expect(exp.step8).toEqual(expected);
    });
    test("TestLocalVolResult", () => {
        const exp = getLocalVolatilitySurfaceTestData();
        const expected = [
            [
                4.390372004485462, 1.4130115618445476, 0.8091714942866454,
                0.6202787175877049, 0.5710717030365785
            ],
            [
                0.7356995557542183, 0.5238534491134649, 0.49811940172188496,
                0.4627841702949896, 0.44888138423759666
            ],
            [
                0.423952233269856, 0.43887539024876937, 0.4398011726644918,
                0.41800970247025454, 0.4192634123524543
            ],
            [
                0.37977032595641685, 0.429914934251023, 0.43287214238357835,
                0.41001600524771126, 0.41563022319363535
            ],
            [
                0.3723682327147875, 0.4303996501420203, 0.4333068631308418,
                0.4089991943865628, 0.4180168733950998
            ],
            [
                0.37291942587176663, 0.42880380011368613, 0.43206570789988,
                0.40555701695782087, 0.41753266302342457
            ],
            [
                0.38540720071858764, 0.4280876583340149, 0.432503478167467,
                0.404193094779451, 0.4175938736403768
            ],
            [
                0.4405897126788497, 0.4150786601743814, 0.4314480394704425,
                0.4041707285193984, 0.4171113516821456
            ],
            [
                0.6796863851942871, 0.4232419849165942, 0.4366995288013861,
                0.4149167422313336, 0.4167170839203356
            ]
        ];
        expect(exp.getResult()).toEqual(expected);
    });
});
